# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Windows Build & Publish Installer

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

env:
  FLUTTER_CHANNEL: stable
  APP_NAME: e_market_app
  INSTALLER_BASE: EMarket_Setup
  RELEASE_REPO: bishoyabdmariam/release_e_market

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set app version from tag
        shell: pwsh
        env:
          VERSION: ${{ github.ref_name }}
          BUILD_NUM: ${{ github.run_number }}
        run: |
          $v = "${env:VERSION}".TrimStart('v')
          $b = "${env:BUILD_NUM}"
          (Get-Content pubspec.yaml) -replace '^version: .+', "version: $v+$b" | Set-Content pubspec.yaml

      - uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows runner
        run: flutter build windows --release

      - name: Install Inno Setup
        shell: pwsh
        run: |
          if (Test-Path "C:\Program Files (x86)\Inno Setup 6\ISCC.exe") {
            Write-Host "Inno Setup already installed."
          } else {
            choco install innosetup --no-progress -y
          }

      - name: Create Inno Setup script
        shell: pwsh
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          $v = "${env:VERSION}".TrimStart('v')
          $OutputDir = "$PWD\installer"
          New-Item -ItemType Directory -Force -Path $OutputDir | Out-Null

          $iss = @(
            '[Setup]',
            "AppName=E-Market",
            "AppVersion=$v",
            'AppId={{E4E5A4C1-6C02-4D5B-8B8A-1B1A1E0F1234}}',
            'DefaultDirName={pf}\E-Market',
            "OutputDir=$OutputDir",
            "OutputBaseFilename=${{ env.INSTALLER_BASE }}",
            'Compression=lzma',
            'SolidCompression=yes',
            'DisableDirPage=yes',
            'DisableProgramGroupPage=yes',
            'ArchitecturesAllowed=x64',
            'ArchitecturesInstallIn64BitMode=x64',
            '',
            '[Files]',
            'Source:"build/windows/x64/runner/Release\*"; DestDir:"{app}"; Flags: recursesubdirs ignoreversion',
            '',
            '[Icons]',
            'Name:"{autoprograms}\E-Market"; Filename:"{app}\${{ env.APP_NAME }}.exe"'
          ) -join "`n"
          Set-Content -Path "installer.iss" -Value $iss

      - name: Build Windows installer (Inno Setup)
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: installer/${{ env.INSTALLER_BASE }}.exe

      - name: Create/Update GitHub Release (release repo)
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.RELEASE_REPO_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          $repo = "${{ env.RELEASE_REPO }}"
          $tag = "$env:TAG"
          $file = "installer/${{ env.INSTALLER_BASE }}.exe"

          if ([string]::IsNullOrWhiteSpace($env:GH_TOKEN)) {
            throw "Missing secret RELEASE_REPO_TOKEN in the main repo. Add a PAT with access to $repo."
          }

          if (!(Test-Path $file)) {
            throw "Installer not found at $file"
          }

          # If the release repo is empty, bootstrap it with an initial commit so GitHub can create tags/releases.
          $hasCommits = $true
          try {
            gh api "repos/$repo/commits" -F per_page=1 *> $null
          } catch {
            $hasCommits = $false
          }

          if (-not $hasCommits) {
            Write-Host "Release repo appears empty. Bootstrapping with an initial commit..."
            $tmp = Join-Path $env:RUNNER_TEMP "release_repo_bootstrap"
            if (Test-Path $tmp) { Remove-Item -Recurse -Force $tmp }

            git clone "https://x-access-token:$env:GH_TOKEN@github.com/$repo.git" $tmp
            Push-Location $tmp

            git config user.email "actions@github.com"
            git config user.name "github-actions"

            "Release artifacts for E-Market." | Set-Content -Path "README.md"
            git add README.md
            git commit -m "chore: bootstrap repo" || $true

            # Ensure a default branch exists (main).
            git branch -M main
            git push -u origin main

            Pop-Location
          }

          # Create release if it doesn't exist; otherwise upload/replace asset.
          gh release view $tag --repo $repo *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create $tag $file --repo $repo --title $tag --notes "Automated Windows installer for $tag"
          } else {
            gh release upload $tag $file --repo $repo --clobber
          }

      - name: Update backend version
        shell: pwsh
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          $v = "${env:VERSION}".TrimStart('v')
          
          # Generate a random token (UUID-based)
          $token = [System.Guid]::NewGuid().ToString()
          
          # Construct download URL
          $downloadUrl = "https://github.com/${{ env.RELEASE_REPO }}/releases/download/${{ github.ref_name }}/${{ env.INSTALLER_BASE }}.exe"
          
          # Prepare request body
          $body = @{
            latestVersion = $v
            minimumVersion = $v
            updateRequired = $true
            forceUpdate = $true
            downloadUrl = $downloadUrl
            releaseNotes = "New features and bug fixes"
          } | ConvertTo-Json
          
          # Make PUT request to update backend version
          $headers = @{
            "Content-Type" = "application/json"
            "Authorization" = "Bearer $token"
          }
          
          try {
            $response = Invoke-RestMethod -Uri "https://e-market-backend-vaph.onrender.com/app/version" `
              -Method Put `
              -Headers $headers `
              -Body $body `
              -ErrorAction Stop
            Write-Host "Successfully updated backend version to $v"
            Write-Host "Response: $($response | ConvertTo-Json)"
          } catch {
            Write-Host "Error updating backend version: $_"
            Write-Host "Status Code: $($_.Exception.Response.StatusCode.value__)"
            throw
          }